<script> @minify
// --------------------------------------------------------------------------
(function( $, io, document, window, undefined ){
    // ----------------------------------------------------------------------

    // ----------------------------------------------------------------------
    var template = @json( $new->section ); // Section template
    var toast = {
        heading: '@lang('label.error')', icon: 'error',
        stack: false, hideAfter: 3000,
        position: { right: 18, top: 68 }
    };
    // ----------------------------------------------------------------------

    // ----------------------------------------------------------------------
    // Sale plan section
    // ----------------------------------------------------------------------
    Vue.component( 'plan-section', {
        // ------------------------------------------------------------------
        props: [ 'value', 'index', 'plan', 'sheet', 'disabled' ],
        template: '#plan-section',
        // ------------------------------------------------------------------

        // ------------------------------------------------------------------
        // Reactive data
        // ------------------------------------------------------------------
        data: function(){
            // --------------------------------------------------------------
            var data = {
                status: { loading: false },
                entry: this.value,
                preset: {
                    tax: @json( $tax, JSON_NUMERIC_CHECK )
                }
            };
            // --------------------------------------------------------------

            // --------------------------------------------------------------
            // console.log( data.entry );
            return data;
            // --------------------------------------------------------------
        },
        // ------------------------------------------------------------------

        // ------------------------------------------------------------------
        // Computed properties
        // ------------------------------------------------------------------
        computed: {
            // --------------------------------------------------------------
            prefix: function(){
                var entry = this.entry;
                var prefix = 'new-plan-section-';
                return entry.id ? 'plan-section-' +entry.id+ '-' : prefix;
            },
            // --------------------------------------------------------------

            // --------------------------------------------------------------
            // Find out if this section is disabled
            // --------------------------------------------------------------
            isDisabled: function(){
                var disabled = this.disabled || false;
                return disabled || this.status.loading;
            },
            // --------------------------------------------------------------

            // --------------------------------------------------------------
            // Get plan-section reference area
            // https://bit.ly/2XwfkJY
            // --------------------------------------------------------------
            referenceArea: function(){
                var vm = this; var entry = this.entry;
                if( vm.plan && vm.sheet ){
                    // ------------------------------------------------------
                    var sections = vm.plan.sections;
                    var checklist = vm.sheet.checklist;
                    // ------------------------------------------------------
                    var result = null;
                    var area = Vue.filter('tsubo')( checklist.effective_area );
                    // ------------------------------------------------------
                    if( area && sections.length ){
                        result = floorDecimal( area / sections.length, 2 );
                    }
                    // ------------------------------------------------------
                    return result;
                    // ------------------------------------------------------
                }
                // ----------------------------------------------------------
            },
            // --------------------------------------------------------------

            // --------------------------------------------------------------
            // Get plan-section unit-price
            // https://bit.ly/3aZrgIi
            // --------------------------------------------------------------
            unitPrice: function( section ){
                // ----------------------------------------------------------
                var result = null;
                var entry = this.entry;
                // ----------------------------------------------------------
                if( entry.unit_selling_price && entry.planned_area ){
                    result = Math.floor( entry.unit_selling_price / entry.planned_area );
                }
                // ----------------------------------------------------------
                return result;
                // ----------------------------------------------------------
            },
            // --------------------------------------------------------------
        },
        // ------------------------------------------------------------------

        // ------------------------------------------------------------------
        // Watchers
        // ------------------------------------------------------------------
        watch: {
            // --------------------------------------------------------------
            referenceArea: function( value ){ 
                this.entry.reference_area = value;
            },
            // --------------------------------------------------------------
            unitPrice: function( value ){ 
                this.entry.unit_price = value;
            },
            // --------------------------------------------------------------
        },
        // ------------------------------------------------------------------

        // ------------------------------------------------------------------
        // Component methods
        // ------------------------------------------------------------------
        methods: {
            // --------------------------------------------------------------
            // Update brokerage fee sign based on fee type
            // https://bit.ly/2K5AZB2
            // --------------------------------------------------------------
            updateBrokerageFeeSign: function(){
                var entry = this.entry;
                if( entry.brokerage_fee ){
                    // --------------------------------------------------
                    var absolute = Math.abs( entry.brokerage_fee );
                    // --------------------------------------------------
                    if( 2 === entry.brokerage_fee_type ){
                        entry.brokerage_fee = absolute * -1;
                        return;
                    }
                    // --------------------------------------------------
                    entry.brokerage_fee = absolute;
                    // --------------------------------------------------
                }
            },
            // --------------------------------------------------------------

            // --------------------------------------------------------------
            // Calculate brokerage-fee
            // (( S32-2 * 0.03 ) + 60000 ) * ( 1 + global-tax )ã€€(round down)
            // https://bit.ly/2wA4JTk
            // --------------------------------------------------------------
            calculateBrokerageFee: function( section ){
                // ------------------------------------------------------
                var entry = this.entry;
                var result = entry.brokerage_fee;
                // ------------------------------------------------------
                if( entry.unit_selling_price ){
                    // --------------------------------------------------
                    var tax = this.preset.tax / 100;
                    console.log( 1 + tax );
                    result = Math.floor((( entry.unit_selling_price * 0.03 ) + 60000 ) * ( 1 + tax ));
                    // --------------------------------------------------
                    result = Math.abs( result );
                    if( 2 === entry.brokerage_fee_type ) result = result * -1;
                    // --------------------------------------------------
                }
                // ------------------------------------------------------
                entry.brokerage_fee = result;
                // ------------------------------------------------------
            },
            // --------------------------------------------------------------

            // --------------------------------------------------------------
            // Create new section
            // --------------------------------------------------------------
            createNew: function(){
                // ----------------------------------------------------------
                var plan = this.plan;
                var sections = io.get( this, 'plan.sections' );
                // ----------------------------------------------------------
                if( plan && sections ){
                    var entry = $.extend( true, {}, template );
                    // ------------------------------------------------------
                    entry.pj_sale_plan_id = plan.id || null;
                    entry.divisions_number = sections.length +1;
                    // ------------------------------------------------------
                    sections.push( entry );
                };
                // ----------------------------------------------------------
            },
            // --------------------------------------------------------------

            // --------------------------------------------------------------
            // Remove section
            // --------------------------------------------------------------
            remove: function(){
                // ----------------------------------------------------------
                var vm = this; 
                var entry = vm.entry; var index = vm.index;
                var sections = io.get( vm, 'plan.sections' );
                // ----------------------------------------------------------

                // ----------------------------------------------------------
                if( index >= 0 ){
                    // ------------------------------------------------------
                    var confirmed = confirm("@lang('label.confirm_delete')");
                    if( confirmed ){
                        // --------------------------------------------------
                        if( !entry.id ){ // If the section is newly added
                            vm.$emit('removed'); // Emit a removed event
                            return; // Exit
                        }
                        // --------------------------------------------------

                        // --------------------------------------------------
                        // Otherwise, delete the section from the database
                        // --------------------------------------------------
                        vm.status.loading = true;
                        var alert = $.extend( true, {}, toast );
                        // --------------------------------------------------
                        var url = '{{ URL::current() }}';
                        var request = axios.delete( url, { params: { section: entry.id }}); // Do the request
                        // --------------------------------------------------

                        // --------------------------------------------------
                        request.then( function( response ){
                            // ----------------------------------------------
                            var status = io.get( response, 'data.status' );
                            if( 'success' == status ){
                                // ------------------------------------------
                                vm.$emit('removed'); // Emit a removed event
                                // ------------------------------------------
                                alert.icon = 'success';
                                alert.heading = '@lang('label.success')';
                                alert.text = '@lang('label.success_delete_message')';
                                // ------------------------------------------
                            }
                            // ----------------------------------------------
                            else alert.text = '@lang('label.failed_delete_message')';
                            // ----------------------------------------------

                            // ----------------------------------------------
                            $.toast( alert ); // Display the alert
                            // ----------------------------------------------
                        });
                        // --------------------------------------------------

                        // --------------------------------------------------
                        // On failed
                        // --------------------------------------------------
                        request.catch( function(e){ console.log(e);
                            alert.text = '@lang('label.failed_delete_message')';
                            $.toast( alert );
                        });
                        // --------------------------------------------------
                        request.finally( function(){ vm.status.loading = false });
                        // --------------------------------------------------
                    }
                    // ------------------------------------------------------
                }
                // ----------------------------------------------------------
            },
            // --------------------------------------------------------------
        }
        // ------------------------------------------------------------------
    });
    // ----------------------------------------------------------------------
}( jQuery, _, document, window ));
// --------------------------------------------------------------------------
@endminify </script>