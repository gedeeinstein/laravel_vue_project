<script> @minify
// --------------------------------------------------------------------------
(function( $, io, document, window, undefined ){
    // ----------------------------------------------------------------------

    // ----------------------------------------------------------------------
    var template = @json( $new->section ); // Section template
    var toast = {
        heading: '@lang('label.error')', icon: 'error',
        stack: false, hideAfter: 3000,
        position: { right: 18, top: 68 }
    };
    // ----------------------------------------------------------------------

    // ----------------------------------------------------------------------
    // Sale plan tab
    // ----------------------------------------------------------------------
    Vue.component( 'plan-tab', {
        // ------------------------------------------------------------------
        props: [ 'value', 'index', 'sale', 'sheet', 'disabled' ],
        template: '#plan-tab',
        // ------------------------------------------------------------------

        // ------------------------------------------------------------------
        // Reactive data
        // ------------------------------------------------------------------
        data: function(){
            // --------------------------------------------------------------
            var data = {
                status: { loading: false },
                entry: this.value,
            };
            // --------------------------------------------------------------

            // --------------------------------------------------------------
            // console.log( data.entry );
            return data;
            // --------------------------------------------------------------
        },
        // ------------------------------------------------------------------

        // ------------------------------------------------------------------
        // Computed properties
        // ------------------------------------------------------------------
        computed: {
            // --------------------------------------------------------------
            // Find out if this section is disabled
            // --------------------------------------------------------------
            isDisabled: function(){
                return this.disabled || false;
            },
            // --------------------------------------------------------------
        },
        // ------------------------------------------------------------------

        // ------------------------------------------------------------------
        // Component methods
        // ------------------------------------------------------------------
        methods: {
            // --------------------------------------------------------------
            // Avtivate current plan
            // --------------------------------------------------------------
            activate: function( entry ){
                // ----------------------------------------------------------
                var entry = this.entry; var index = this.index;
                var plans = io.get( this, 'sale.plans' );
                // ----------------------------------------------------------
                $.each( plans, function( planIndex, plan ){
                    var active = index == planIndex;
                    Vue.set( plan, 'active', active );
                });
                // ----------------------------------------------------------
            },
            // --------------------------------------------------------------


            // --------------------------------------------------------------
            // Avtivate target plan by the index
            // --------------------------------------------------------------
            activatePlan: function( index ){
                // ----------------------------------------------------------
                var plans = io.get( this, 'sale.plans' );
                // ----------------------------------------------------------
                $.each( plans, function( planIndex, plan ){
                    var active = index == planIndex;
                    Vue.set( plan, 'active', active );
                });
                // ----------------------------------------------------------
            },
            // --------------------------------------------------------------


            // ----------------------------------------------------------
            // Duplicate sale plan
            // ----------------------------------------------------------
            duplicate: function(){
                // ------------------------------------------------------
                var vm = this;
                var reference = vm.entry;
                var plans = io.get( this, 'sale.plans' );
                // ------------------------------------------------------

                // ------------------------------------------------------
                if( plans && plans.length ){
                    // --------------------------------------------------
                    var plan = io.cloneDeep( reference );
                    if( plan.id ) delete plan.id;
                    plan.pj_sale_id = null;
                    // --------------------------------------------------
                    plan.plan_name = plan.plan_name + ' Copy';
                    plan.plan_creator = '{{ $user->full_name }}';
                    plan.tab_index = plans.length +1;
                    plan.created_at = 'pending';
                    // --------------------------------------------------
                    if( plan.updated_at ) delete plan.updated_at;
                    // --------------------------------------------------


                    // --------------------------------------------------
                    // Plan sections
                    // --------------------------------------------------
                    if( plan.sections && plan.sections.length ){
                        $.each( plan.sections, function( s, section ){
                            // ------------------------------
                            if( section.id ) delete section.id;
                            section.pj_sale_plan_id = null;
                            // ------------------------------
                            if( section.created_at ) delete section.created_at;
                            if( section.updated_at ) delete section.updated_at;
                            // ------------------------------
                        });
                    }
                    // --------------------------------------------------

                    // --------------------------------------------------
                    plans.push( plan ); // Push new sheet to the list
                    // --------------------------------------------------

                    // --------------------------------------------------
                    // Activate sheet
                    // --------------------------------------------------
                    $.each( plans, function( i, entry ){ Vue.set( entry, 'active', false )});
                    Vue.set( plan, 'active', true );
                    // --------------------------------------------------

                    // --------------------------------------------------
                    // Request server time based on server timezone
                    // --------------------------------------------------
                    var url = '/api/server/time';
                    var request = axios.get( url ); // Do the request
                    // --------------------------------------------------
                    request.then( function( response ){
                        if( response.data ){
                            var serverTime = response.data;
                            Vue.set( plan, 'created_at', serverTime ); // Update sheet time
                        }
                    });
                    // --------------------------------------------------
                }
                // ------------------------------------------------------
            },
            // ----------------------------------------------------------


            // --------------------------------------------------------------
            // Remove plan
            // --------------------------------------------------------------
            remove: function(){
                // ----------------------------------------------------------
                var vm = this; var entry = vm.entry; 
                var sale = this.sale; var plans = sale.plans;
                var index = this.index; var wasActive = entry.active;
                // ----------------------------------------------------------

                // ----------------------------------------------------------
                if( index >= 0 && sale && plans ){
                    // ------------------------------------------------------
                    var confirmed = confirm("@lang('label.confirm_delete')");
                    if( confirmed ){
                        // --------------------------------------------------
                        // If the plan is newly added
                        // --------------------------------------------------
                        if( !entry.id ){
                            // ----------------------------------------------
                            plans.splice( index, 1 ); // Remove the plan
                            // ----------------------------------------------
                            // If removed plan was an active one,
                            // move the active state to the alternate plan
                            // ----------------------------------------------
                            if( wasActive ){
                                var alternate = 0;
                                if( 0 !== index ) alternate = index -1;
                                vm.activatePlan( alternate );
                            }
                            // ----------------------------------------------
                            return; // Exit
                            // ----------------------------------------------
                        }
                        // --------------------------------------------------

                        // --------------------------------------------------
                        var alert = $.extend({}, toast );
                        // --------------------------------------------------

                        // --------------------------------------------------
                        // Otherwise, do an xhr request
                        // to delete the plan data on database
                        // --------------------------------------------------
                        var url = '{{ URL::current() }}';
                        var request = axios.delete( url, { params: { plan: entry.id }}); // Do the request
                        // --------------------------------------------------
                        request.then( function( response ){
                            // ----------------------------------------------
                            var status = io.get( response, 'data.status' );
                            if( 'success' == status ){
                                // ------------------------------------------
                                plans.splice( index, 1 ); // Remove the plan
                                // ------------------------------------------

                                // ------------------------------------------
                                alert.icon = 'success';
                                alert.heading = '@lang('label.success')';
                                alert.text = '@lang('label.success_delete_message')';
                                // ------------------------------------------

                                // ------------------------------------------
                                // If removed plan was an active one,
                                // move the active state to the alternate plan
                                // ------------------------------------------
                                if( wasActive ){
                                    var alternate = 0;
                                    if( 0 !== index ) alternate = index -1;
                                    vm.activatePlan( alternate );
                                }
                                // ------------------------------------------
                            }
                            // ----------------------------------------------
                            else alert.text = '@lang('label.failed_delete_message')';
                            // ----------------------------------------------

                            // ----------------------------------------------
                            $.toast( alert ); // Display the notif
                            // ----------------------------------------------
                        });
                        // --------------------------------------------------

                        // --------------------------------------------------
                        // On failed
                        // --------------------------------------------------
                        request.catch( function(e){ console.log(e);
                            alert.text = '@lang('label.failed_delete_message')';
                            $.toast( alert );
                        });
                        // --------------------------------------------------
                        request.finally( function(){ vm.status.loading = false });
                        // --------------------------------------------------
                    }
                    // ------------------------------------------------------
                }
                // ----------------------------------------------------------
            },
            // --------------------------------------------------------------
        }
        // ------------------------------------------------------------------
    });
    // ----------------------------------------------------------------------
}( jQuery, _, document, window ));
// --------------------------------------------------------------------------
@endminify </script>