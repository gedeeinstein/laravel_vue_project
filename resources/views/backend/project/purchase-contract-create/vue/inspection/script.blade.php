<script> @minify
// --------------------------------------------------------------------------
(function( $, io, document, window, undefined ){
    // ----------------------------------------------------------------------

    
    // ----------------------------------------------------------------------
    // Toast default options
    // ----------------------------------------------------------------------
    var toast = {
        heading: '@lang('label.error')', icon: 'error',
        stack: false, hideAfter: 3000,
        position: { right: 18, top: 68 }
    };
    // ----------------------------------------------------------------------


    // ----------------------------------------------------------------------
    // Project inspection
    // ----------------------------------------------------------------------
    Vue.component( 'inspection', {
        // ------------------------------------------------------------------
        props: [ 'value', 'project', 'form', 'queue', 'disabled', 'user' ],
        template: '#inspection',
        // ------------------------------------------------------------------

        // ------------------------------------------------------------------
        // Reactive data
        // ------------------------------------------------------------------
        data: function(){
            // --------------------------------------------------------------
            var data = {
                status: { loading: false },
                entry: this.value,
                format: {
                    date: 'YYYY/MM/DD HH:mm'
                }
            };
            // --------------------------------------------------------------

            // --------------------------------------------------------------
            // console.log( data.entry );
            return data;
            // --------------------------------------------------------------
        },
        // ------------------------------------------------------------------

        // ------------------------------------------------------------------
        // Computed properties
        // ------------------------------------------------------------------
        computed: {
            // --------------------------------------------------------------
            // Find out if this component is disabled
            // --------------------------------------------------------------
            isDisabled: function(){
                return this.disabled || this.status.loading;
            },
            // --------------------------------------------------------------

            
            // --------------------------------------------------------------
            // Format request date
            // --------------------------------------------------------------
            requestDate: function(){
                var date = io.get( this, 'entry.request_datetime' );
                if( date ) return moment( date ).format( this.format.date );
            },
            // --------------------------------------------------------------

            // --------------------------------------------------------------
            // Get request author
            // --------------------------------------------------------------
            requestAuthor: function(){
                var fullname = io.get( this, 'entry.user.full_name' );
                return fullname;
            },
            // --------------------------------------------------------------

            // --------------------------------------------------------------
            // Editable status when user role is global admin
            // --------------------------------------------------------------
            editable: function(){
                var role = io.get( this, 'user.role.name' );
                return 'global_admin' === role;
            }
            // --------------------------------------------------------------
        },
        // ------------------------------------------------------------------


        // ------------------------------------------------------------------
        methods: {
            // --------------------------------------------------------------
            // Update project inspection status
            // --------------------------------------------------------------
            update: function(){
                // ----------------------------------------------------------
                var vm = this; 
                var entry = vm.entry;
                var project = vm.project;
                $( vm.form ).submit();
                // ----------------------------------------------------------

                // ----------------------------------------------------------
                // Catch the form submit promise
                // ----------------------------------------------------------
                var queue = this.queue;
                setTimeout( function(){
                    if( queue.save ) queue.save.then( function( response ){
                        // --------------------------------------------------
                        vm.status.loading = true;
                        // --------------------------------------------------
                        var url = '{{ route('project.inspection.update') }}/' +entry.id;
                        var updates = { examination: entry.examination };
                        var request = axios.post( url, { updates: updates });
                        // --------------------------------------------------

                        // --------------------------------------------------
                        // Receive the request response
                        // --------------------------------------------------
                        request.then( function( response ){
                            // ----------------------------------------------
                            var option = $.extend( {}, toast );
                            var status = io.get( response, 'data.status' );
                            // ----------------------------------------------

                            // ----------------------------------------------
                            if( 'success' == status ){
                                // ------------------------------------------
                                option.icon = 'success';
                                option.heading = '@lang('label.success')';
                                option.text = '{{ __('label.approval_updated') }}';
                                // ------------------------------------------
                            } else option.text = '{{ __('label.approval_failed') }}';
                            // ----------------------------------------------

                            // ----------------------------------------------
                            $.toast( option );
                            // ----------------------------------------------
                        });
                        // --------------------------------------------------

                        // --------------------------------------------------
                        request.catch( function(){
                            var option = $.extend( {}, toast, {
                                text: '{{ __('label.approval_failed') }}'
                            }); $.toast( option );
                        });
                        // --------------------------------------------------
                        request.finally( function(){ vm.status.loading = false });
                        // --------------------------------------------------
                    });
                });
                // ----------------------------------------------------------
            }
            // --------------------------------------------------------------
        }
        // ------------------------------------------------------------------
    });
    // ----------------------------------------------------------------------
}( jQuery, _, document, window ));
// --------------------------------------------------------------------------
@endminify </script>