<?php
// --------------------------------------------------------------------------
namespace App\Http\Controllers\Backend\Project;
// --------------------------------------------------------------------------
use App\Models\PjMemo;
use App\Models\PjPurchaseSale as Sale;
use App\Models\PjPurchaseSalePjMemo as SaleMemo;
// --------------------------------------------------------------------------
use Carbon\Carbon;
use Illuminate\Http\Request;
use App\Http\Controllers\Controller;
use Illuminate\Support\Facades\Auth;
// --------------------------------------------------------------------------

// --------------------------------------------------------------------------
class ProjectMemoController extends Controller {
    // ----------------------------------------------------------------------

    // ----------------------------------------------------------------------
    // Handle create request
    // ----------------------------------------------------------------------
    public function create( Request $request ){
        $user = Auth::user();
        // ------------------------------------------------------------------
        $response = new \stdClass;
        $response->status = 'success';
        $response->heading = __('label.success');
        $response->text = __('label.success_create_message');
        // ------------------------------------------------------------------

        // ------------------------------------------------------------------
        // Create the new memo
        // ------------------------------------------------------------------
        if( !empty( $request->entry )){
            $entry = (object) $request->entry;
            if( !empty( $entry->content ) && !empty( $entry->project_id )){
                // ----------------------------------------------------------
                $memo = new PjMemo();
                $memo->project_id = $entry->project_id;
                $memo->content = $entry->content;
                $memo->user_id = $user->id;
                $memo->disabled = false;
                // ----------------------------------------------------------
                $memo->save(); // Save as new entry
                // ----------------------------------------------------------

                // ----------------------------------------------------------
                // Also create purchase-sale memo entry
                // ----------------------------------------------------------
                $sale = Sale::where( 'project_id', (int) $entry->project_id )->first();
                if( $sale ){
                    // ------------------------------------------------------
                    $saleMemo = new SaleMemo();
                    $saleMemo->pj_purchase_sale_id = $sale->id;
                    $saleMemo->pj_memo_id = $memo->id;
                    $saleMemo->content = $memo->content;
                    // ------------------------------------------------------
                    $saleMemo->save();
                    // ------------------------------------------------------
                }
                // ----------------------------------------------------------

                // ----------------------------------------------------------
                if( $memo->id ){
                    $response->entry = PjMemo::with('user')->find( $memo->id );
                }
                // ----------------------------------------------------------
                else {
                    $response->status = 'error';
                    $response->heading = __('label.error');
                    $response->text = __('label.failed_create_message');
                }
                // ----------------------------------------------------------
            }
        }
        // ------------------------------------------------------------------

        // ------------------------------------------------------------------
        return response()->json( $response );
        // ------------------------------------------------------------------
    }
    // ----------------------------------------------------------------------

    // ----------------------------------------------------------------------
    // Handle update request
    // ----------------------------------------------------------------------
    public function update( Request $request ){
        // ------------------------------------------------------------------
        $response = new \stdClass;
        $response->status = 'success';
        $response->heading = __('label.success');
        $response->text = __('label.success_update_message');
        // ------------------------------------------------------------------

        // ------------------------------------------------------------------
        // Process the updates
        // ------------------------------------------------------------------
        if( !empty( $request->entry )){
            $entry = (object) $request->entry;
            if( !empty( $entry->id )){
                // ----------------------------------------------------------
                $model = PjMemo::with('saleMemo')->find( $entry->id );
                if( !$model ){
                    $response->status = 'error';
                    $response->heading = __('label.error');
                    $response->text = __('label.failed_update_message');
                }
                // ----------------------------------------------------------
                else {
                    // ------------------------------------------------------
                    if( !empty( $entry->content )){
                        $model->content = $entry->content;
                        // --------------------------------------------------

                        // --------------------------------------------------
                        // Update the sale memo content
                        // --------------------------------------------------
                        if( !empty( $model->saleMemo )){
                            $model->saleMemo->content = $entry->content;
                            $model->saleMemo->save();
                        }
                        // --------------------------------------------------
                    }
                    // ------------------------------------------------------
                    $model->save(); // Save as new entry
                    // ------------------------------------------------------
                }
                // ----------------------------------------------------------
            }
        }
        // ------------------------------------------------------------------

        // ------------------------------------------------------------------
        return response()->json( $response );
        // ------------------------------------------------------------------
    }
    // ----------------------------------------------------------------------

    // ----------------------------------------------------------------------
    // Handle delete request
    // A deleted memo will be set as disabled instead of actually deleting it
    // ----------------------------------------------------------------------
    public function delete( $id ){
        // ------------------------------------------------------------------
        $response = new \stdClass;
        $response->status = 'success';
        $response->heading = __('label.success');
        $response->text = __('label.success_delete_message');
        // ------------------------------------------------------------------

        // ------------------------------------------------------------------
        // Process the updates
        // ------------------------------------------------------------------
        if( !empty( $id )){
            $model = PjMemo::with('saleMemo')->find( $id );
            // --------------------------------------------------------------
            if( !$model ){
                $response->status = 'error';
                $response->heading = __('label.error');
                $response->text = __('label.failed_delete_message');
            }
            // --------------------------------------------------------------
            else {
                // ----------------------------------------------------------
                $model->disabled = true; // Disable the memo
                // ----------------------------------------------------------

                // ----------------------------------------------------------
                // Soft delete the sale memo
                // ----------------------------------------------------------
                if( !empty( $model->saleMemo )) $model->saleMemo->delete();
                // ----------------------------------------------------------

                // ----------------------------------------------------------
                $model->save(); // Save the changes
                // ----------------------------------------------------------
            };
            // --------------------------------------------------------------
        }
        // ------------------------------------------------------------------

        // ------------------------------------------------------------------
        return response()->json( $response );
        // ------------------------------------------------------------------
    }
    // ----------------------------------------------------------------------
}
// --------------------------------------------------------------------------
