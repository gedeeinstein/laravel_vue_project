<?php
// --------------------------------------------------------------------------
namespace App\Models;
use Illuminate\Database\Eloquent\Model;
// --------------------------------------------------------------------------
use App\Models\PjSale as Sale;
use App\Models\PjStock as Stock;
use App\Models\Project as Project;
use App\Models\PjChecklist as Checklist;
// --------------------------------------------------------------------------

// --------------------------------------------------------------------------
class PjSheet extends Model {
    // ----------------------------------------------------------------------
    protected $table = 'pj_sheets';
    protected $fillable = [
        'name',
        'memo',
        'tab_index',
        'project_id',
        'creator_name',
        'is_reflecting_in_budget'
    ];
    // ----------------------------------------------------------------------

    // ----------------------------------------------------------------------
    // Project which the sheet belongs to
    // ----------------------------------------------------------------------
    public function project(){
        return $this->belongsTo( Project::class );
    }
    // ----------------------------------------------------------------------
    

    // ----------------------------------------------------------------------
    // Sheet checklist with default values
    // ----------------------------------------------------------------------
    public function checklist(){
        // ------------------------------------------------------------------
        // Create default value with the factory state
        // ------------------------------------------------------------------
        $default = factory( Checklist::class )->state('init')->make()->toArray();
        // ------------------------------------------------------------------
        return $this->hasOne( Checklist::class )->withDefault( function( $checklist, $sheet ) use( $default ){
            // --------------------------------------------------------------
            // Assign the default values
            // --------------------------------------------------------------
            foreach( $default as $field => $value ) $checklist->{ $field } = $value;
            // --------------------------------------------------------------

            // --------------------------------------------------------------
            // Replace foreign key with current sheet ID
            // --------------------------------------------------------------
            $checklist->pj_sheet_id = $sheet->id;
            // --------------------------------------------------------------
        });
        // ------------------------------------------------------------------
    }
    // ----------------------------------------------------------------------


    // ----------------------------------------------------------------------
    // Sheet purchasing/stock
    // ----------------------------------------------------------------------
    public function stock(){
        return $this->hasOne( Stock::class );
    }
    // ----------------------------------------------------------------------


    // ----------------------------------------------------------------------
    // Sheet sales
    // ----------------------------------------------------------------------
    public function sale(){
        return $this->hasOne( Sale::class );
    }
    // ----------------------------------------------------------------------
}
